<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Violin Mastery Quest – Full Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="description" content="A comprehensive violin training app grounded in pedagogy and music theory with drills, intervals, tempo training, note locator and Bieler method lab." />
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --ink: #0f172a;
      --ink-light: #475569;
      --primary: #6d28d9;
      --primary-dark: #5b21b6;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #dc2626;
      --border: rgba(0,0,0,0.1);
    }
    :root.dark {
      --bg: #0b1426;
      --card: #0f1f3d;
      --ink: #e2e8f0;
      --ink-light: #94a3b8;
      --primary: #a78bfa;
      --primary-dark: #7c3aed;
      --success: #22c55e;
      --warning: #fbbf24;
      --danger: #ef4444;
      --border: rgba(255,255,255,0.15);
    }
    body { margin:0; font-family: Inter, system-ui, sans-serif; background: var(--bg); color: var(--ink); padding-bottom: 60px; }
    .container { max-width: 960px; margin:auto; padding: 1rem; }
    .card { background: var(--card); border:1px solid var(--border); border-radius:12px; padding:1rem 1.5rem; margin-bottom:1.5rem; box-shadow:0 4px 20px rgba(0,0,0,0.05); }
    h1,h2,h3 { margin:0; }
    h2 { margin-bottom:0.5rem; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:0.6rem 1rem; border-radius:9999px; border:none; font-weight:600; color:#fff; margin:0.25rem; cursor:pointer; }
    .btn-primary { background: var(--primary); }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--ink-light); }
    .btn-secondary:hover { background: var(--ink); }
    .btn-success { background: var(--success); }
    .btn-warning { background: var(--warning); }
    .btn-danger { background: var(--danger); }
    .grid { display:grid; gap:1rem; }
    @media(min-width:640px){ .grid-cols-2 { grid-template-columns: repeat(2, 1fr);} }
    @media(min-width:1024px){ .grid-cols-3 { grid-template-columns: repeat(3, 1fr);} }
    .tabs { display:flex; border-bottom:1px solid var(--border); margin-bottom:1rem; }
    .tab { flex:1; text-align:center; padding:0.6rem 0; cursor:pointer; border-bottom:3px solid transparent; color: var(--ink-light); }
    .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight:600; }
    .progress-bar { width:100%; height:8px; background: var(--border); border-radius:9999px; overflow:hidden; margin-top:0.25rem; }
    .progress-bar>div { height:100%; background: var(--primary); }
    .heat-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:0.25rem; }
    .heat-cell { height:2rem; display:flex; align-items:center; justify-content:center; font-size:0.75rem; color:#fff; border-radius:6px; }
  </style>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // LocalStorage helpers
    const loadJSON=(k,fb)=>{try{const v=JSON.parse(localStorage.getItem(k)); return v??fb;}catch{return fb;}};
    const saveJSON=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}};
    // Violin constants
    const STRINGS=['G','D','A','E'];
    const POSITIONS=[1,2,3,4,5];
    const FINGERS=[1,2,3,4];
    const OPEN_PC={G:7,D:2,A:9,E:4};
    const BASE_OFF={1:2,2:4,3:5,4:7};
    const POS_SHIFT={1:0,2:2,3:3,4:5,5:7};
    const NOTE_NAME={0:'C',1:'Db',2:'D',3:'Eb',4:'E',5:'F',6:'F#',7:'G',8:'Ab',9:'A',10:'Bb',11:'B'};
    const canonicalBase=(s,p,f)=>{const semi=OPEN_PC[s]+POS_SHIFT[p]+BASE_OFF[f]; return NOTE_NAME[((semi%12)+12)%12];};
    const CELLS=[]; for(const s of STRINGS) for(const p of POSITIONS) for(const f of FINGERS){ CELLS.push({s,p,f,canon:canonicalBase(s,p,f)}); }
    // XP & Stats
    const XP_KEY='vmq.full.xp';
    const STATS_KEY='vmq.full.stats';
    const levelForXP=(xp)=>Math.floor(Math.pow(xp/250,0.75))+1;
    const nextLevelXP=(lvl)=>Math.round(250*Math.pow(lvl,1.4));
    const addXP=(amt)=>{ const xp=loadJSON(XP_KEY,0)+amt; saveJSON(XP_KEY,xp); return xp; };
    const updateStat=(key,correct)=>{
      const stats=loadJSON(STATS_KEY,{});
      const st=stats[key]||{correct:0,total:0}; st.total+=1; if(correct) st.correct+=1; stats[key]=st; saveJSON(STATS_KEY,stats);
    };
    const shuffle=(arr)=>{const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };
    const getRandom=(arr)=>arr[Math.floor(Math.random()*arr.length)];
    const ordinal=(n)=>{const s=['th','st','nd','rd'],v=n%100; return n+(s[(v-20)%10]||s[v]||s[0]);};

    /* Drills and Study components */
    function SpeedDrill({onBack}){
      const [time,setTime]=React.useState(90);
      const [score,setScore]=React.useState(0);
      const [answered,setAnswered]=React.useState(0);
      const [question,setQuestion]=React.useState(null);
      const stats=loadJSON(STATS_KEY,{});
      const pick=()=>{
        // Weighted random cell (weaker ones have more weight)
        const weight=(c)=>{
          const k=`${c.s}:${c.p}:${c.f}`;
          const st=stats[k]||{correct:0,total:0};
          const acc=st.total?st.correct/st.total:0;
          return 1-acc+0.05;
        };
        const total=CELLS.reduce((sum,c)=>sum+weight(c),0);
        let r=Math.random()*total; let chosen=CELLS[CELLS.length-1];
        for(const c of CELLS){ r-=weight(c); if(r<=0){ chosen=c; break; } }
        const correct=chosen.canon;
        const options=shuffle([correct,...shuffle([...new Set(CELLS.map(c=>c.canon))].filter(n=>n!==correct)).slice(0,3)]);
        setQuestion({cell:chosen,options});
      };
      React.useEffect(()=>{ pick(); const id=setInterval(()=>setTime(t=>t<=1?0:t-1),1000); return ()=>clearInterval(id); },[]);
      const answer=(opt)=>{
        const ok= opt===question.cell.canon;
        setAnswered(a=>a+1);
        if(ok) setScore(s=>s+1);
        updateStat(`${question.cell.s}:${question.cell.p}:${question.cell.f}`, ok);
        addXP(ok?8:2);
        pick();
      };
      if(time===0){ return (<div className="card"><h2>Speed Drill Complete</h2><p>Score {score}/{answered}</p><button className="btn btn-secondary" onClick={onBack}>Back</button></div>); }
      return (
        <div>
          <div className="card">
            <h2>Speed Drill</h2>
            <p>Time: {time}s | Score: {score}/{answered}</p>
            {question && (
              <div>
                <p>What is the base note at <strong>{ordinal(question.cell.p)} position, {ordinal(question.cell.f)} finger on {question.cell.s}</strong> string?</p>
                <div className="grid grid-cols-2">
                  {question.options.map(opt=>(<button key={opt} className="btn btn-primary" onClick={()=>answer(opt)}>{opt}</button>))}
                </div>
              </div>
            )}
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }

    function Flashcards({onBack}){
      const [deck,setDeck]=React.useState(()=>{
        const saved=loadJSON('vmq.full.flashcards',null);
        if(saved) return saved;
        const cards=[];
        CELLS.forEach(c=>{ cards.push({q:`Note at ${ordinal(c.p)} pos, ${ordinal(c.f)} finger on ${c.s}`, a:c.canon, interval:1, due:Date.now()}); });
        const unique=[...new Set(CELLS.map(c=>c.canon))];
        unique.forEach(n=>{ cards.push({q:`Locations for note ${n}?`, a:n, interval:1, due:Date.now()}); });
        saveJSON('vmq.full.flashcards',cards);
        return cards;
      });
      const [card,setCard]=React.useState(null);
      const [show,setShow]=React.useState(false);
      const pick=()=>{
        const now=Date.now();
        const due=deck.filter(c=>c.due<=now);
        const next= due.length? due[0] : getRandom(deck);
        setCard(next);
        setShow(false);
      };
      React.useEffect(()=>{ pick(); },[]);
      const mark=(known)=>{
        setDeck(prev=>{
          const updated=prev.map(c=>{
            if(c===card){ const newInt= known? c.interval*2 : 1; return {...c, interval:newInt, due: Date.now()+newInt*24*3600*1000}; } return c; });
          saveJSON('vmq.full.flashcards',updated); return updated;
        });
        addXP(known?5:1);
        pick();
      };
      return (
        <div>
          <div className="card">
            <h2>Flashcards</h2>
            {card && (
              <div>
                <p>{card.q}</p>
                {show ? (<p style={{fontWeight:'bold',fontSize:'1.4rem'}}>{card.a}</p>) : (<button className="btn btn-primary" onClick={()=>setShow(true)}>Reveal</button>)}
                {show && (
                  <div style={{marginTop:'0.5rem'}}>
                    <button className="btn btn-success" onClick={()=>mark(true)}>I knew it</button>
                    <button className="btn btn-secondary" onClick={()=>mark(false)}>I forgot</button>
                  </div>
                )}
              </div>
            )}
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }

    function Snapshot({onBack}){
      const [time,setTime]=React.useState(60);
      const [score,setScore]=React.useState(0);
      const [answered,setAnswered]=React.useState(0);
      const [state,setState]=React.useState('flash');
      const [flash,setFlash]=React.useState(null);
      const [q,setQ]=React.useState(null);
      const pick=()=>{
        const s=getRandom(STRINGS);
        const p=getRandom(POSITIONS);
        const labels={}; FINGERS.forEach(f=>{ labels[f]=canonicalBase(s,p,f); });
        setFlash({s,p,labels}); setState('flash');
        setTimeout(()=>{
          const f=getRandom(FINGERS);
          const correct=labels[f];
          const opts=shuffle([correct,...shuffle([...new Set(CELLS.map(c=>c.canon))].filter(n=>n!==correct)).slice(0,3)]);
          setQ({s,p,f,correct,options:opts}); setState('question');
        },1400);
      };
      React.useEffect(()=>{ pick(); const id=setInterval(()=>setTime(t=>t<=1?0:t-1),1000); return ()=>clearInterval(id); },[]);
      const answer=(opt)=>{
        const ok= opt===q.correct;
        setAnswered(a=>a+1);
        if(ok) setScore(s=>s+1);
        updateStat(`${q.s}:${q.p}:${q.f}`, ok);
        addXP(ok?6:2);
        pick();
      };
      if(time===0){ return (<div className="card"><h2>Snapshot Complete</h2><p>Score {score}/{answered}</p><button className="btn btn-secondary" onClick={onBack}>Back</button></div>); }
      return (
        <div>
          <div className="card">
            <h2>Snapshot</h2>
            <p>Time: {time}s | Score: {score}/{answered}</p>
            {state==='flash' && flash && (
              <div>
                <p>Memorize base notes: {flash.s} string, {ordinal(flash.p)} position</p>
                <div className="grid grid-cols-2">
                  {FINGERS.map(f=>(<div key={f} className="card" style={{padding:'0.5rem',textAlign:'center'}}><small>F{f}</small><br/><strong>{flash.labels[f]}</strong></div>))}
                </div>
              </div>
            )}
            {state==='question' && q && (
              <div>
                <p>Which base note is F{q.f} at {ordinal(q.p)} pos on {q.s} string?</p>
                <div className="grid grid-cols-2">
                  {q.options.map(opt=>(<button key={opt} className="btn btn-primary" onClick={()=>answer(opt)}>{opt}</button>))}
                </div>
              </div>
            )}
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }

    function IntervalSprint({onBack}){
      const [time,setTime]=React.useState(60);
      const [score,setScore]=React.useState(0);
      const [answered,setAnswered]=React.useState(0);
      const [q,setQ]=React.useState(null);
      const pick=()=>{
        const s=getRandom(STRINGS);
        const p=getRandom(POSITIONS);
        const pair=getRandom([[1,2],[2,3],[3,4]]);
        const [a,b]=pair;
        const semi=(s,p,f)=>OPEN_PC[s]+POS_SHIFT[p]+BASE_OFF[f];
        const diff=Math.abs((semi(s,p,b)-semi(s,p,a)+12)%12);
        const type= diff===1? 'half' : 'whole';
        setQ({s,p,a,b,type});
      };
      React.useEffect(()=>{ pick(); const id=setInterval(()=>setTime(t=>t<=1?0:t-1),1000); return ()=>clearInterval(id); },[]);
      const answer=(choice)=>{
        const ok= choice===q.type;
        setAnswered(a=>a+1);
        if(ok) setScore(s=>s+1);
        updateStat(`${q.s}:${q.p}:${q.a}-${q.b}`, ok);
        addXP(ok?4:1);
        pick();
      };
      if(time===0){ return (<div className="card"><h2>Interval Sprint Complete</h2><p>Score {score}/{answered}</p><button className="btn btn-secondary" onClick={onBack}>Back</button></div>); }
      return (
        <div>
          <div className="card">
            <h2>Interval Sprint</h2>
            <p>Time: {time}s | Score: {score}/{answered}</p>
            {q && (
              <div>
                <p>At {ordinal(q.p)} position on {q.s} string, between F{q.a} and F{q.b}: half or whole step?</p>
                <div className="grid grid-cols-2">
                  <button className="btn btn-primary" onClick={()=>answer('half')}>Half Step</button>
                  <button className="btn btn-primary" onClick={()=>answer('whole')}>Whole Step</button>
                </div>
              </div>
            )}
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }

    function NoteLocator({onBack}){
      const [time,setTime]=React.useState(60);
      const [score,setScore]=React.useState(0);
      const [answered,setAnswered]=React.useState(0);
      const [q,setQ]=React.useState(null);
      const pick=()=>{
        const s=getRandom(STRINGS);
        const cellsOn=CELLS.filter(c=>c.s===s);
        const chosen=getRandom(cellsOn);
        const note=chosen.canon;
        const correct={p:chosen.p,f:chosen.f};
        const distract=shuffle(cellsOn.filter(c=>c.p!==correct.p||c.f!==correct.f)).slice(0,3);
        const options=shuffle([correct,...distract.map(c=>({p:c.p,f:c.f}))]);
        setQ({s,note,correct,options});
      };
      React.useEffect(()=>{ pick(); const id=setInterval(()=>setTime(t=>t<=1?0:t-1),1000); return ()=>clearInterval(id); },[]);
      const answer=(opt)=>{
        const ok= opt.p===q.correct.p && opt.f===q.correct.f;
        setAnswered(a=>a+1);
        if(ok) setScore(s=>s+1);
        updateStat(`${q.s}:${q.correct.p}:${q.correct.f}`, ok);
        addXP(ok?4:1);
        pick();
      };
      if(time===0){ return (<div className="card"><h2>Note Locator Complete</h2><p>Score {score}/{answered}</p><button className="btn btn-secondary" onClick={onBack}>Back</button></div>); }
      return (
        <div>
          <div className="card">
            <h2>Note Locator</h2>
            <p>Time: {time}s | Score: {score}/{answered}</p>
            {q && (
              <div>
                <p>On the {q.s} string, where can you play <strong>{q.note}</strong> (pos 1–5)?</p>
                <div className="grid grid-cols-2">
                  {q.options.map((opt,i)=>(<button key={i} className="btn btn-primary" onClick={()=>answer(opt)}>Pos {opt.p} — F{opt.f}</button>))}
                </div>
              </div>
            )}
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }

    // Tempo trainer flashcards & tester
    const TEMPOS=[
      {it:'Prestissimo', en:'extremely fast', range:'≥ 200 bpm'},
      {it:'Presto',      en:'very fast',    range:'168–200 bpm'},
      {it:'Allegro',     en:'fast, lively', range:'120–168 bpm'},
      {it:'Allegretto',  en:'moderately fast', range:'112–120 bpm'},
      {it:'Andante',     en:'walking tempo', range:'76–108 bpm'},
      {it:'Andantino',   en:'slightly faster than Andante', range:'80–112 bpm'},
      {it:'Adagio',      en:'slow, majestic', range:'66–76 bpm'},
      {it:'Largo',       en:'very broad and slow', range:'40–60 bpm'},
      {it:'Lento',       en:'very slow', range:'40–60 bpm'}
    ];
    function TempoTrainer({onBack}){
      const [index,setIndex]=React.useState(0);
      const [show,setShow]=React.useState(false);
      const say=(text)=>{ try{ const u=new SpeechSynthesisUtterance(text); u.rate=0.9; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} };
      const next=()=>{ setShow(false); setIndex((index+1)%TEMPOS.length); };
      const prev=()=>{ setShow(false); setIndex((index-1+TEMPOS.length)%TEMPOS.length); };
      const t=TEMPOS[index];
      return (
        <div>
          <div className="card">
            <h2>Tempo Trainer</h2>
            <p><strong>{t.it}</strong></p>
            {show ? (
              <p>{t.en} — {t.range}</p>
            ) : (<button className="btn btn-primary" onClick={()=>setShow(true)}>Reveal</button>)}
            <div style={{marginTop:'0.5rem'}}>
              <button className="btn btn-secondary" onClick={prev}>Prev</button>
              <button className="btn btn-primary" onClick={next}>Next</button>
              <button className="btn btn-success" onClick={()=>{say(t.it); say(t.en);}}>Speak</button>
            </div>
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }
    function TempoTester({onBack}){
      const [time,setTime]=React.useState(60);
      const [score,setScore]=React.useState(0);
      const [answered,setAnswered]=React.useState(0);
      const [q,setQ]=React.useState(null);
      const pick=()=>{
        const term=getRandom(TEMPOS);
        const correct=term.en;
        const choices=shuffle([correct,...shuffle(TEMPOS.map(x=>x.en).filter(x=>x!==correct)).slice(0,3)]);
        setQ({term:term.it, correct, options:choices});
      };
      React.useEffect(()=>{ pick(); const id=setInterval(()=>setTime(t=>t<=1?0:t-1),1000); return ()=>clearInterval(id); },[]);
      const answer=(opt)=>{
        const ok= opt===q.correct;
        setAnswered(a=>a+1);
        if(ok) setScore(s=>s+1);
        addXP(ok?5:2);
        pick();
      };
      if(time===0){ return (<div className="card"><h2>Tempo Tester Complete</h2><p>Score {score}/{answered}</p><button className="btn btn-secondary" onClick={onBack}>Back</button></div>); }
      return (
        <div>
          <div className="card">
            <h2>Tempo Tester</h2>
            <p>Time: {time}s | Score: {score}/{answered}</p>
            {q && (
              <div>
                <p>What does <strong>{q.term}</strong> mean?</p>
                <div className="grid grid-cols-2">
                  {q.options.map((opt,i)=>(<button key={i} className="btn btn-primary" onClick={()=>answer(opt)}>{opt}</button>))}
                </div>
              </div>
            )}
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }

    // Bieler Method Lab (updated definitions)
    const BIELER_VOCAB=[
      {term:'Hand Frame',def:'Consistent whole-step and half-step spacing of the fingers that travels as a unit during shifts, ensuring solid intonation.'},
      {term:'Three-Dimensional Positioning',def:'Balanced height, depth and angle of the violin and bow, freeing both hands for ease and tone.'},
      {term:'Contact Point',def:'Soundpoint on the string chosen by bow speed, pressure and tilt to produce the desired tone colour.'},
      {term:'Collé',def:'Articulation starting from the fingers, pinching and releasing the bow to produce crisp attacks.'}
    ];
    const BIELER_CONCEPT=[
      {q:'Why establish a hand frame before focusing on speed?',a:'It solidifies spacing so finger motion remains accurate at higher tempi.',wrong:['To increase vibrato','To avoid shifting entirely','Because hand size dictates positions']},
      {q:'What should determine your contact point?',a:'The balance of bow speed, pressure and tilt to achieve your intended tone colour.',wrong:['Finger curvature','String brand','Arm length']},
      {q:'How does spiccato differ from sautillé?',a:'Spiccato is a placed, rebounding stroke; sautillé is a natural spring at faster tempi.',wrong:['They are identical','Sautillé must be loud','Spiccato is legato only']}
    ];
    const BIELER_APPLY=[
      {scenario:'Projecting a bright forte on the A string',a:'Move the soundpoint toward the bridge; increase bow speed with supportive index; maintain hand frame.',wrong:['Play over the fingerboard with a light bow','Use only vibrato for projection','Press harder with the thumb']},
      {scenario:'Clean off-string stroke at MM=100 (8ths)',a:'Use spiccato near the bow’s balance point with a small vertical motion and consistent levels.',wrong:['Throw the bow widely at the tip','Use heavy martelé at the frog','Ricochet near the bridge']},
      {scenario:'Playing a dolce line in 3rd position',a:'Move contact point slightly over the fingerboard, reduce pressure, maintain seamless legato and glide the frame through shifts.',wrong:['Use firm staccato','Keep a stiff collé','Always play sul ponticello']}
    ];
    function BielerLab({onBack}){
      const [tab,setTab]=React.useState('vocab');
      const [index,setIndex]=React.useState(0);
      const [revealed,setRevealed]=React.useState(false);
      const [mcq,setMcq]=React.useState(null);
      const pickMCQ=(type)=>{
        const bank= type==='concept'? BIELER_CONCEPT : BIELER_APPLY;
        const item=getRandom(bank);
        const opts=shuffle([item.a,...shuffle(item.wrong).slice(0,3)]);
        setMcq({stem: type==='concept'? item.q : item.scenario, correct:item.a, options:opts, type});
      };
      React.useEffect(()=>{ if(tab==='concept' || tab==='apply'){ pickMCQ(tab==='concept'?'concept':'apply'); } },[tab]);
      const answer=(choice)=>{
        const ok= choice===mcq.correct;
        addXP(ok?4:1);
        setTimeout(()=>pickMCQ(mcq.type),200);
      };
      return (
        <div>
          <div className="card">
            <h2>Bieler Method Lab</h2>
            <div className="tabs">
              {['vocab','concept','apply'].map(t=>(<div key={t} className={`tab ${tab===t?'active':''}`} onClick={()=>{setTab(t); setRevealed(false);}}>{t==='vocab'?'Vocabulary':t==='concept'?'Concept':'Apply'}</div>))}
            </div>
            {tab==='vocab' && (
              <div style={{textAlign:'center'}}>
                <h3>{BIELER_VOCAB[index].term}</h3>
                {revealed ? (<p>{BIELER_VOCAB[index].def}</p>) : (<button className="btn btn-primary" onClick={()=>setRevealed(true)}>Reveal</button>)}
                <div style={{marginTop:'0.5rem'}}>
                  <button className="btn btn-secondary" onClick={()=>{ setRevealed(false); setIndex((index-1+BIELER_VOCAB.length)%BIELER_VOCAB.length);}}>Prev</button>
                  <button className="btn btn-primary" onClick={()=>{ setRevealed(false); setIndex((index+1)%BIELER_VOCAB.length);}}>Next</button>
                </div>
              </div>
            )}
            {(tab==='concept' || tab==='apply') && mcq && (
              <div style={{textAlign:'center'}}>
                <p><strong>{mcq.stem}</strong></p>
                <div className="grid grid-cols-2">
                  {mcq.options.map((opt,i)=>(<button key={i} className="btn btn-primary" onClick={()=>answer(opt)}>{opt}</button>))}
                </div>
              </div>
            )}
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }

    // Interval Study (reference sheet) — presents a table of interval names and semitone counts as study material
    const INTERVALS=[
      {name:'Minor 2nd', semitones:1, desc:'Half step'},
      {name:'Major 2nd', semitones:2, desc:'Whole step'},
      {name:'Minor 3rd', semitones:3, desc:''},
      {name:'Major 3rd', semitones:4, desc:''},
      {name:'Perfect 4th', semitones:5, desc:''},
      {name:'Tritone', semitones:6, desc:'Augmented 4th / Diminished 5th'},
      {name:'Perfect 5th', semitones:7, desc:''},
      {name:'Minor 6th', semitones:8, desc:''},
      {name:'Major 6th', semitones:9, desc:''},
      {name:'Minor 7th', semitones:10, desc:''},
      {name:'Major 7th', semitones:11, desc:''},
      {name:'Perfect 8th (Octave)', semitones:12, desc:''}
    ];
    function IntervalStudy({onBack}){
      return (
        <div>
          <div className="card">
            <h2>Intervals Reference</h2>
            <p>Intervals describe the distance between two pitches. Use this table to memorise common intervals by name and semitone count.</p>
            <table style={{width:'100%', borderCollapse:'collapse'}}>
              <thead><tr><th style={{textAlign:'left', padding:'4px', borderBottom:`1px solid var(--border)`}}>Interval</th><th style={{textAlign:'left', padding:'4px', borderBottom:`1px solid var(--border)`}}>Semitones</th><th style={{textAlign:'left', padding:'4px', borderBottom:`1px solid var(--border)`}}>Notes</th></tr></thead>
              <tbody>
              {INTERVALS.map((it,i)=>(
                <tr key={i} style={{borderBottom:`1px solid var(--border)`}}>
                  <td style={{padding:'4px'}}>{it.name}</td>
                  <td style={{padding:'4px'}}>{it.semitones}</td>
                  <td style={{padding:'4px'}}>{it.desc}</td>
                </tr>
              ))}
              </tbody>
            </table>
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }

    function StatsPage({onBack}){
      const stats=loadJSON(STATS_KEY,{});
      const xp=loadJSON(XP_KEY,0);
      const level=levelForXP(xp);
      const prev= level>1? nextLevelXP(level-1):0;
      const next= nextLevelXP(level);
      const pct=(xp-prev)/(next-prev);
      return (
        <div>
          <div className="card">
            <h2>Your Progress</h2>
            <p>Level {level} (XP {xp-prev}/{next-prev})</p>
            <div className="progress-bar"><div style={{width:`${Math.min(100,pct*100)}%`}}></div></div>
          </div>
          <div className="card">
            <h2>Fingerboard Accuracy</h2>
            <div className="heat-grid">
              {CELLS.map(c=>{
                const k=`${c.s}:${c.p}:${c.f}`;
                const st=stats[k]||{correct:0,total:0};
                const acc= st.total? st.correct/st.total : 0;
                let color;
                if(st.total===0) color='var(--danger)';
                else if(acc<0.5) color='var(--warning)';
                else if(acc<0.8) color='#facc15';
                else color='var(--success)';
                const label= st.total? `${Math.round(acc*100)}%` : '-';
                return <div key={k} className="heat-cell" style={{background:color}}>{label}</div>;
              })}
            </div>
          </div>
          <button className="btn btn-secondary" onClick={onBack}>Back</button>
        </div>
      );
    }

    function App(){
      const [page,setPage]=React.useState('home');
      return (
        <div className="container">
          {page==='home' && (
            <div>
              <h1>Violin Mastery Quest</h1>
              <p style={{color:'var(--ink-light)'}}>Evidence‑based practice for violin positions, notes, intervals and technique. Explore drills, study materials and performance analytics.</p>
              <div className="grid grid-cols-2">
                <div className="card">
                  <h2>Drills</h2>
                  <button className="btn btn-primary" onClick={()=>setPage('speed')}>Speed Drill</button>
                  <button className="btn btn-primary" onClick={()=>setPage('snapshot')}>Snapshot</button>
                  <button className="btn btn-primary" onClick={()=>setPage('interval')}>Interval Sprint</button>
                  <button className="btn btn-primary" onClick={()=>setPage('locator')}>Note Locator</button>
                </div>
                <div className="card">
                  <h2>Study</h2>
                  <button className="btn btn-primary" onClick={()=>setPage('flash')}>Flashcards</button>
                  <button className="btn btn-primary" onClick={()=>setPage('bieler')}>Bieler Lab</button>
                  <button className="btn btn-primary" onClick={()=>setPage('tempo')}>Tempo Trainer</button>
                  <button className="btn btn-primary" onClick={()=>setPage('intervals')}>Intervals Reference</button>
                </div>
                <div className="card">
                  <h2>Tests</h2>
                  <button className="btn btn-primary" onClick={()=>setPage('tempoTest')}>Tempo Tester</button>
                  <button className="btn btn-primary" onClick={()=>setPage('stats')}>View Stats</button>
                </div>
              </div>
            </div>
          )}
          {page==='speed'     && <SpeedDrill onBack={()=>setPage('home')}/>}
          {page==='flash'     && <Flashcards onBack={()=>setPage('home')}/>}
          {page==='snapshot'  && <Snapshot   onBack={()=>setPage('home')}/>}
          {page==='interval'  && <IntervalSprint onBack={()=>setPage('home')}/>}
          {page==='locator'   && <NoteLocator onBack={()=>setPage('home')}/>}
          {page==='bieler'    && <BielerLab  onBack={()=>setPage('home')}/>}
          {page==='tempo'     && <TempoTrainer onBack={()=>setPage('home')}/>}
          {page==='tempoTest' && <TempoTester  onBack={()=>setPage('home')}/>}
          {page==='intervals' && <IntervalStudy onBack={()=>setPage('home')}/>}
          {page==='stats'     && <StatsPage   onBack={()=>setPage('home')}/>}
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>